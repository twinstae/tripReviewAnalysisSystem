{% extends 'proto/home.html' %}

{% block specific-style %}

{% endblock specific-style %}

{% block title %} TARS Map {% endblock title%}

{% block content %}

    <div id="map" style = "height: 800px"></div>

    {% for Attraction in attractions_list %}
    <div class = "Card">
	<div class="w3-quarter w3-card" id = "{{ Attraction.pk }}">
		{% load static %}
		<img src="{% static "image/"|add:Attraction.name|add:".jpg" %}" alt="title" style="width:100%">
		<h3>{{Attraction.name}}</h3>
		<span class="w3-round-xxlarge w3-tag" style = "background-color:#fff0b3; color:#ff9900;">star</span>
		<span class="w3-round-xxlarge w3-tag w3-color"> tag_name </span>
		<div class="button_container"></div>
	</div>
	{% endfor %}

    <script>
		var select_data = ['abc','이건가'];

		{% for Attraction in attractions_list %}
		var popup{{ Attraction.pk }}, Popup{{ Attraction.pk }};
		{% endfor %}

        function initMap() {
			var directionsService = new google.maps.DirectionsService();
			var directionsRenderer = new google.maps.DirectionsRenderer();
			map = new google.maps.Map(document.getElementById('map'), {
			center: {lat: 37.612085, lng: 127.00825},
			zoom:12
			});
			directionsRenderer.setMap(map);
			{% for Attraction in attractions_list %}

			var AttrPosition = {lat: {{ Attraction.latitude }}, lng: {{ Attraction.longitude }}};

			var marker{{ Attraction.pk }} = new google.maps.Marker({
				position: AttrPosition,
				map: map
			});
			marker{{ Attraction.pk }}.setMap(map);

			marker{{ Attraction.pk }}.addListener('click', function() {
				popup()

				let name = "{{Attraction.name}}";
				let pk = {{ Attraction.pk }};
				$.ajax({
				  type: "POST",
				  url: "{% url 'new_r' %}",
				  data: {'pk':pk, 'name': name ,'csrfmiddlewaretoken': '{{ csrf_token }}'},
				  dataType: "json",
				  success: function(response){
					// 배열이 아니면 에러 출력
					console.assert(Array.isArray(response), {errorMsg: "response is not an Array of Attraction"});

					response.forEach(function(attraciton){
						// name이나 latitude가 누락되면 에러 출력
						console.assert(attraction.hasOwnProperty('name'),attraciton)
						console.assert(attraction.hasOwnProperty('latitude'),attraciton)

						placeMarkerAndPanTo(attraciton);
					});
				  }
				});
			});

			marker{{ Attraction.pk }}.addListener('mouseout', function(){
				setTimeout(function(){ popup{{ Attraction.pk }}.setMap(null); }, 10000);
			});

			{% endfor %}
		}

		function placeMarkerAndPanTo(new_attraction) {

			var marker = new google.maps.Marker({
				position: {lat: new_attraction.latitude, lng: new_attraction.longitude},
				map: map
				});

			map.panTo({lat: new_attraction.latitude, lng: new_attraction.longitude})
		}

		function calcRoute(startAttraction, endAttraction, directionsService, directionsRenderer) {
			  start = new google.maps.LatLng(startAttraction['latitude'], startAttraction['longitude']);
			  end = new google.maps.LatLng(endAttraction['latitude'], endAttraction['longitude']);
			  var request = {
				origin: start,
				destination: end,
				travelMode: 'TRANSIT'
			  };
			  directionsService.route(request, function(result, status) {
				if (status == 'OK') {
				  console.log(result);
				  directionsRenderer.setDirections(result);
				}
			  });
		}
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuP0QbhWgKwx5mwDm1jV2pZXYU4FtGhQ4&callback=initMap"
    async defer></script>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  {% load static %}
  <script src="{% static "js/Card.js" %}" type="text/babel"></script>
  
{% endblock content %}
